<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoiq8woGXo_hibNIDK3gsBSR56zgU4FEvPP0-lmdfv24Bt_l0hz6Jyh0jCsG8W_pKYsB2JKEGzaURo/pub?output=csv";

// üìç CENTRO (modifica se serve)
const CENTRO = { lat: 44.14919, lon: 12.13341 }; 

// üåç Mappa
const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

// Marker centro
L.marker([CENTRO.lat, CENTRO.lon])
  .addTo(map)
  .bindPopup("<b>Location</b>")
  .openPopup();

// üìè Distanza Haversine
function distanzaKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

// üì• Carica CSV correttamente
Papa.parse(csvURL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {

    const dati = results.data.map(p => {
      if (!p.Coordinate) return null;

      const [lat, lon] = p.Coordinate.split(";").map(Number);
      if (isNaN(lat) || isNaN(lon)) return null;

      p.lat = lat;
      p.lon = lon;
      p.distanza = distanzaKm(CENTRO.lat, CENTRO.lon, lat, lon);
      return p;
    }).filter(Boolean);

    // Ordina per distanza
    dati.sort((a, b) => a.distanza - b.distanza);

    // Tabella + Marker
    let html = "";
    dati.forEach(p => {

      L.marker([p.lat, p.lon])
        .addTo(map)
        .bindPopup(`<b>${p.Etichetta}</b><br>${p.Indirizzo}`);

      html += `
        <tr>
          <td>${p.Etichetta}</td>
          <td>${p.Indirizzo}</td>
          <td>${p.Posti || "-"}</td>
          <td>${p.distanza.toFixed(2)}</td>
          <td>
            <a href="${p['Link Google Maps']}" target="_blank">Apri</a>
          </td>
        </tr>`;
    });

    document.getElementById("tabella").innerHTML = html;
  }
});
</script>