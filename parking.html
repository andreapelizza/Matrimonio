<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Parcheggi Matrimonio</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; }
h1 { padding: 10px; }
#map { height: 400px; margin: 10px; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; margin: 10px; font-size: 14px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { background: #f2f2f2; }
tr:hover { background: #fafafa; }
</style>
</head>
<body>

<h1>Parcheggi Matrimonio</h1>

<div id="map"></div>

<table>
  <thead>
    <tr>
      <th>Parcheggio</th>
      <th>Indirizzo</th>
      <th>Posti ed Accessibilità</th>
      <th>Distanza (km)</th>
      <th>Lunghezza percorso (km)</th>
      <th>Dislivello (m)</th>
      <th>Mappa</th>
    </tr>
  </thead>
  <tbody id="tabella"></tbody>
</table>

<script>
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoiq8woGXo_hibNIDK3gsBSR56zgU4FEvPP0-lmdfv24Bt_l0hz6Jyh0jCsG8W_pKYsB2JKEGzaURo/pub?output=csv";

const CENTRO = { lat: 44.14919, lon: 12.13341 };

// Inizializza mappa
const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

// Marker centro
L.marker([CENTRO.lat, CENTRO.lon])
  .addTo(map)
  .bindPopup("<b>Location Matrimonio</b>")
  .openPopup();

// Carica CSV con PapaParse
Papa.parse(csvURL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  dynamicTyping: false,      // Legge tutto come stringa
  trimHeaders: true,         // Rimuove spazi nelle intestazioni
  transform: value => value.trim(), // Rimuove spazi nelle celle
  complete: function(results) {
    const dati = results.data
      .map(p => {
        // Coordinate
        const lat = parseFloat(p.Latitudine || p['Latitudine']);
        const lon = parseFloat(p.Longitudine || p['Longitudine']);
        const descrizione = p.Descrizione || p['Descrizione'] || "Parcheggio";

        if (!descrizione || isNaN(lat) || isNaN(lon)) return null;

        // Trova la colonna "Posti ed Accessibilità" indipendentemente da emoji/parentesi
        const postiKey = Object.keys(p).find(k => k.toLowerCase().includes("posti") && k.toLowerCase().includes("access"));
        const posti_valore = postiKey ? p[postiKey] : "-";

        p.lat = lat;
        p.lon = lon;
        p.label = descrizione;
        p.posti = posti_valore;
        return p;
      })
      .filter(Boolean);

    // Ordina per distanza (se presente)
    dati.sort((a, b) => parseFloat(a['Distanza in linea d\'aria'] || 0) - parseFloat(b['Distanza in linea d\'aria'] || 0));

    let html = "";
    dati.forEach((p, index) => {
      // Marker mappa
      L.marker([p.lat, p.lon])
        .addTo(map)
        .bindPopup(`
          <b>${p.label}</b><br>
          ${p.Indirizzo || "-"}<br>
          Posti ed Accessibilità: ${p.posti}<br>
          Distanza: ${p['Distanza in linea d\'aria'] || "-"} m<br>
          Lunghezza percorso: ${p['Lunghezza del percorso'] || "-"} m<br>
          Dislivello: ${p.Dislivello || "-"} m
        `);

      // Riga tabella
      html += `
        <tr${index < 3 ? ' style="background-color:#e0ffe0"' : ''}>
          <td>${p.label}</td>
          <td>${p.Indirizzo || "-"}</td>
          <td>${p.posti}</td>
          <td>${p['Distanza in linea d\'aria'] || "-"}</td>
          <td>${p['Lunghezza del percorso'] || "-"}</td>
          <td>${p.Dislivello || "-"}</td>
          <td><a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank">Apri</a></td>
        </tr>`;
    });

    document.getElementById("tabella").innerHTML = html;
  },
  error: function(err) {
    console.error("Errore CSV:", err);
  }
});
</script>

</body>
</html>
