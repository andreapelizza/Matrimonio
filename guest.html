<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Matrimonio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: 'Kaushan Script', cursive;
  margin: 0;
}

#controls {
  padding: 10px;
  background: white;
  font-size: 14px;
}

#map {
  height: calc(100vh - 140px);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.legend-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
}

button {
  margin-top: 8px;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  background: #1976d2;
  color: white;
  font-size: 14px;
}
</style>
</head>

<body>

<div id="controls">
  <b>Livelli</b><br>
  <div id="checkboxes"></div>
  <button onclick="showNearestParking()">üÖøÔ∏è Parcheggi pi√π vicini</button>
  <hr>
  <b>Legenda</b>
  <div id="legend"></div>
</div>

<div id="map"></div>

<script>
const CENTRO = { lat: 44.14919, lon: 12.13341 };
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBV9faZqgv88uu4_Z790474hIu-ik9XnOOQckWEWuPeMKSQ26VQrXwGCBeFn-WLRb7nbU0sd1pqkBg/pub?output=csv";

const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const categoryLayers = {};
const categoryInfo = {};
let parkingData = [];
let parkingCounter = 1;

// ICONA
function icon(symbol, color) {
  return L.divIcon({
    html: `<div style="background:${color};width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;border:2px solid white">${symbol}</div>`,
    iconSize: [32,32],
    iconAnchor: [16,32]
  });
}

// MUNICIPIO
L.marker([CENTRO.lat, CENTRO.lon], {
  icon: icon('üèõÔ∏è', '#8e24aa')
}).addTo(map);

// CSV
Papa.parse(csvURL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: res => {
    res.data.forEach(r => {
      const lat = parseFloat(r.Latitudine);
      const lon = parseFloat(r.Longitudine);
      if (isNaN(lat) || isNaN(lon)) return;

      const cat = r.Categoria || 'Altro';
      let symbol = r.Simbolo?.trim();
      const color = r.Colore || '#FF9800';

      if (cat === 'Parcheggi' && !symbol) {
        symbol = 'P' + parkingCounter++;
      }

      if (!categoryLayers[cat]) {
        categoryLayers[cat] = L.markerClusterGroup({
          iconCreateFunction: cluster => {
            return L.divIcon({
              html: `<div style="background:${color};color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center">${cluster.getChildCount()}</div>`,
              iconSize: [40,40]
            });
          }
        });
        map.addLayer(categoryLayers[cat]);
        categoryInfo[cat] = { symbol, color };
      }

      let popup = `<b>${r.Descrizione}</b><br>${r.Indirizzo || ''}<br>`;

      if (cat === 'Parcheggi') {
        popup += `
          Posti auto: ${r['Posti auto'] || '-'}<br>
          Distanza: ${r['Distanza in linea d\'aria dal Comune'] || '-'} m<br>
        `;
        parkingData.push({ lat, lon, markerData: r });
      }

      if (r.Telefono) popup += `<a href="tel:${r.Telefono}">üìû Chiama</a><br>`;
      if (r.Link) popup += `<a href="${r.Link}" target="_blank">üß≠ Naviga</a>`;

      categoryLayers[cat].addLayer(
        L.marker([lat, lon], { icon: icon(symbol, color) }).bindPopup(popup)
      );
    });

    buildControls();
  }
});

// CHECKBOX + LEGENDA
function buildControls() {
  const cb = document.getElementById('checkboxes');
  const lg = document.getElementById('legend');

  Object.keys(categoryLayers).forEach(cat => {
    cb.innerHTML += `
      <label>
        <input type="checkbox" checked onchange="toggleLayer('${cat}', this.checked)">
        ${cat}
      </label><br>
    `;

    lg.innerHTML += `
      <div class="legend-item">
        <div class="legend-icon" style="background:${categoryInfo[cat].color}">
          ${categoryInfo[cat].symbol || ''}
        </div>
        ${cat}
      </div>
    `;
  });
}

function toggleLayer(cat, on)
