<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Punti</title>

<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: 'Kaushan Script', sans-serif; margin: 0; }
#map { height: 100vh; width: 95%; max-width: 1200px; margin: auto; border-radius: 8px; }

.marker-municipio div {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #8e24aa;
  color: white;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  border: 2px solid white;
  font-size: 18px;
}

a { color: #1976d2; text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>

<div id="map"></div>

<script>
const CENTRO = { lat: 44.14919, lon: 12.13341 };

// URL CSV
const CSV_PUNTI_PRINCIPALI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=1432190131&single=true&output=csv";
const CSV_PARCHEGGI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=0&single=true&output=csv";
const CSV_ALTRI_PUNTI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=1044807949&single=true&output=csv";

// Inizializza mappa
const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

// Funzioni icone
function createIcon(symbol, color) {
  return L.divIcon({
    className: 'marker-special',
    html: `<div style="background-color:${color}; display:flex; align-items:center; justify-content:center; color:white; border-radius:50%; width:32px; height:32px; border:2px solid white; font-size:18px;">${symbol}</div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });
}

function createMunicipioIcon() {
  return L.divIcon({
    className: 'marker-municipio',
    html: `<div>üèõÔ∏è</div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });
}

// Aggiungi Municipio
L.marker([CENTRO.lat, CENTRO.lon], { icon: createMunicipioIcon() }).addTo(map);

// Funzione generica per caricare CSV e aggiungere marker
function caricaCSV(url, isParcheggio=false) {
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const punti = results.data.map((p, idx) => {
        const lat = parseFloat(p.Latitudine);
        const lon = parseFloat(p.Longitudine);
        if (isNaN(lat) || isNaN(lon)) return null;

        // Simbolo e colore
        let symbol = isParcheggio ? `P${String(idx+1).padStart(2,'0')}` : p[Object.keys(p)[0]];
        let color = isParcheggio ? "#1976d2" : p[Object.keys(p)[1]];

        // Popup con tutte le colonne
        let popup = "";
        for (let key in p) {
          if (key !== Object.keys(p)[0] && key !== Object.keys(p)[1] && p[key]) {
            popup += `<b>${key}:</b> ${p[key]}<br>`;
          }
        }
        popup += `<a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Naviga qui</a>`;

        return { lat, lon, symbol, color, popup };
      }).filter(Boolean);

      punti.forEach(p => {
        L.marker([p.lat, p.lon], { icon: createIcon(p.symbol, p.color) })
          .addTo(map)
          .bindPopup(p.popup);
      });
    }
  });
}

// Carica i CSV
caricaCSV(CSV_PUNTI_PRINCIPALI);
caricaCSV(CSV_PARCHEGGI, true);
caricaCSV(CSV_ALTRI_PUNTI);

</script>
</body>
</html>
