<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Matrimonio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: 'Kaushan Script', cursive;
  margin: 0;
}

#map {
  height: 100vh;
  width: 100%;
}

/* pannello livelli + legenda a destra */
#controlsPanel {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 250px;
  font-size: 14px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.legend-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
}

.leaflet-popup-content {
  font-size: 15px;
  line-height: 1.4;
}

.leaflet-popup-content a {
  display: inline-block;
  margin-top: 6px;
  padding: 6px 10px;
  background: #1976d2;
  color: white;
  border-radius: 6px;
  text-decoration: none;
  font-size: 14px;
}

.leaflet-popup-content a:hover {
  background: #125aa0;
}

@media (max-width: 600px) {
  #controlsPanel {
    max-width: 90%;
    font-size: 16px;
  }
  .leaflet-popup-content {
    font-size: 16px;
  }
}
</style>
</head>

<body>

<div id="controlsPanel">
  <b>Livelli</b><br>
  <div id="checkboxes"></div>
  <hr>
  <b>Legenda</b>
  <div id="legend"></div>
</div>

<div id="map"></div>

<script>
const CENTRO = { lat: 44.14919, lon: 12.13341 };
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBV9faZqgv88uu4_Z790474hIu-ik9XnOOQckWEWuPeMKSQ26VQrXwGCBeFn-WLRb7nbU0sd1pqkBg/pub?gid=10105076&single=true&output=csv";

const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const categoryLayers = {};
const categoryInfo = {};
let parkingCounter = 1;

// FUNZIONE ICONA
function icon(symbol, color) {
  return L.divIcon({
    html: `<div style="background:${color};width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;border:2px solid white">${symbol}</div>`,
    iconSize: [32,32],
    iconAnchor: [16,32]
  });
}

// MUNICIPIO
L.marker([CENTRO.lat, CENTRO.lon], {
  icon: icon('ðŸ›ï¸', '#8e24aa')
}).addTo(map);

// CSV
const FIXED_CATS = ['Ristorante','Brindisi','Casa','Municipio'];

Papa.parse(csvURL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: res => {
    res.data.forEach(r => {
      const lat = parseFloat(r['Latitudine']?.trim());
      const lon = parseFloat(r['Longitudine']?.trim());
      if (isNaN(lat) || isNaN(lon)) return;

      const cat = r['Categoria']?.trim() || 'Altro';
      let symbol = r['Simbolo']?.trim();
      const color = r['Colore']?.trim() || '#FF9800';

      // Parcheggi numerati P01, P02...
      if (cat === 'Parcheggi' && !symbol) {
        symbol = 'P' + String(parkingCounter).padStart(2,'0');
        parkingCounter++;
      }

      // cluster per categoria
      if (!categoryLayers[cat]) {
        categoryLayers[cat] = L.markerClusterGroup({
          iconCreateFunction: cluster => {
            return L.divIcon({
              html: `<div style="background:${color};color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center">${cluster.getChildCount()}</div>`,
              iconSize: [40,40]
            });
          }
        });
        // aggiungi subito layer fisso se Ã¨ categoria fissa
        if (FIXED_CATS.includes(cat)) map.addLayer(categoryLayers[cat]);
        categoryInfo[cat] = { symbol, color };
      }

      // popup
      let popup = `<b>${r['Descrizione']}</b><br>${r['Indirizzo'] || ''}<br>`;
      if (cat !== 'Parcheggi' && r['Telefono']) popup += `<a href="tel:${r['Telefono']}">ðŸ“ž Chiama</a><br>`;
      if (r['Link']) popup += `<a href="${r['Link']}" target="_blank">ðŸ§­ Naviga</a>`;

      categoryLayers[cat].addLayer(
        L.marker([lat, lon], { icon: icon(symbol, color) }).bindPopup(popup)
      );
    });

    buildControls();
  }
});

function buildControls() {
  const cb = document.getElementById('checkboxes');
  const lg = document.getElementById('legend');

  Object.keys(categoryLayers).forEach(cat => {
    // LEGGENDA
    lg.innerHTML += `
      <div class="legend-item">
        <div class="legend-icon" style="background:${categoryInfo[cat].color}">
          ${categoryInfo[cat].symbol || ''}
        </div>
        ${cat}
      </div>
    `;

    // CHECKBOX solo se non Ã¨ categoria fissa
    if (!FIXED_CATS.includes(cat)) {
      cb.innerHTML += `
        <label>
          <input type="checkbox" checked onchange="toggleLayer('${cat}', this.checked)">
          ${cat}
        </label><br>
      `;
      // aggiungi layer inizialmente visibile
      map.addLayer(categoryLayers[cat]);
    }
  });
}

  const cb = document.getElementById('checkboxes');
  const lg = document.getElementById('legend');

  Object.keys(categoryLayers).forEach(cat => {
    cb.innerHTML += `
      <label>
        <input type="checkbox" checked onchange="toggleLayer('${cat}', this.checked)">
        ${cat}
      </label><br>
    `;

    lg.innerHTML += `
      <div class="legend-item">
        <div class="legend-icon" style="background:${categoryInfo[cat].color}">
          ${categoryInfo[cat].symbol || ''}
        </div>
        ${cat}
      </div>
    `;
  });
}

function toggleLayer(cat, on) {
  if (on) map.addLayer(categoryLayers[cat]);
  else map.removeLayer(categoryLayers[cat]);
}
</script>

</body>
</html>
