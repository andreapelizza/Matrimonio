<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Hotel e Punti</title>
<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: 'Kaushan Script', sans-serif; margin:0; }
#map { height:90vh; width:95%; max-width:1200px; margin:auto; border-radius:8px; }
#controls { width:95%; max-width:1200px; margin:auto; padding:5px 0; display:flex; flex-wrap:wrap; gap:10px; font-family: 'Kaushan Script', sans-serif; }
.marker-special div { display:flex; align-items:center; justify-content:center; color:white; border-radius:50%; width:28px; height:28px; border:2px solid white; font-size:14px; }
a { color:#1976d2; text-decoration:none; }
a:hover { text-decoration:underline; }
</style>
</head>
<body>

<div id="controls"></div>
<div id="map"></div>

<script>
const CENTRO = { lat: 44.14919, lon: 12.13341 };
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=1561792900&single=true&output=csv";

const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

function createIcon(symbol, color="#FF9800") {
    return L.divIcon({
        className: 'marker-special',
        html: `<div style="background-color:${color}">${symbol}</div>`,
        iconSize: [28,28],
        iconAnchor: [14,28]
    });
}

const categoryMarkers = {}; // markers divisi per categoria
const alwaysVisibleMarkers = []; // marker che non si possono nascondere

Papa.parse(csvURL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        const categories = new Set();

        results.data.forEach((p,index) => {
            const lat = parseFloat(p['Latitudine']);
            const lon = parseFloat(p['Longitudine']);
            if(isNaN(lat) || isNaN(lon)) return;

            let category = p['Categoria'] || 'Altro';
            if(category.toLowerCase() === 'pizzeria') category = 'Pizzerie e Ristoranti';
            categories.add(category);

            let popupHTML = `<b>${p['Descrizione'] || 'Punto'}</b>`;
            if(p['Indirizzo']) popupHTML += `<br>${p['Indirizzo']}`;
            if(p['Telefono']) popupHTML += `<br>Tel: <a href="tel:${p['Telefono']}">${p['Telefono']}</a>`;
            if(category.toLowerCase().includes('parcheggio')) {
                popupHTML += `<br>Posti: ${p['Posti auto'] || ''}`;
                popupHTML += `<br>Accessibilità: ${p['Accessibilità'] || ''}`;
                popupHTML += `<br>Distanza: ${p['Distanza dal Comune'] || ''}`;
                popupHTML += `<br>Lunghezza percorso: ${p['Lunghezza percorso dal Comune'] || ''}`;
                popupHTML += `<br>Dislivello: ${p['Dislivello'] || ''}`;
            }
            popupHTML += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Naviga qui</a>`;

            const marker = L.marker([lat,lon], { icon: createIcon(p['Simbolo'] || '❓', p['Colore'] || '#FF9800') }).bindPopup(popupHTML);

            // Se è tra le prime 4 righe (index 1→2ª riga, fino index 4→5ª riga) lo rendiamo sempre visibile
            if(index >=1 && index <=4) {
                marker.addTo(map);
                alwaysVisibleMarkers.push(marker);
            } else {
                // aggiungi marker normale per categoria
                if(!categoryMarkers[category]) categoryMarkers[category] = [];
                categoryMarkers[category].push(marker);
                marker.addTo(map);
            }
        });

        // Crea checkbox categorie
        const controlsDiv = document.getElementById('controls');
        categories.forEach(cat => {
            const id = `chk-${cat.replace(/\s+/g,'')}`;
            const label = document.createElement('label');
            label.style.fontFamily = "'Kaushan Script', sans-serif";
            label.innerHTML = `<input type="checkbox" id="${id}" checked> ${cat}`;
            controlsDiv.appendChild(label);

            document.getElementById(id).addEventListener('change', e => {
                const show = e.target.checked;
                categoryMarkers[cat].forEach(m => {
                    if(show) m.addTo(map);
                    else map.removeLayer(m);
                });
                // I marker alwaysVisibleMarkers non vengono mai rimossi
            });
        });
    }
});
</script>
</body>
</html>
