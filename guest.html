<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Hotel e Punti</title>
<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: 'Kaushan Script', sans-serif; margin:0; }
#map { height:95vh; width:95%; max-width:1200px; margin:auto; border-radius:8px; }
.marker-special div { display:flex; align-items:center; justify-content:center; color:white; border-radius:50%; width:28px; height:28px; border:2px solid white; font-size:14px; font-family: 'Kaushan Script', sans-serif; }
a { color:#1976d2; text-decoration:none; font-family: 'Kaushan Script', sans-serif; }
a:hover { text-decoration:underline; font-family: 'Kaushan Script', sans-serif; }
.leaflet-control-layers-overlays label { font-family: 'Kaushan Script', sans-serif; display:flex; align-items:center; gap:4px; }
.leaflet-control-layers-overlays img { width:20px; height:20px; margin-bottom:4px; }
</style>
</head>
<body>
<div id="map"></div>
<script>
const CENTRO = { lat: 44.139605, lon: 12.140695 };
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=1561792900&single=true&output=csv";

const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

function createIcon(symbol, color="#FF9800") {
    return L.divIcon({
        className: 'marker-special',
        html: `<div style="background-color:${color}">${symbol}</div>`,
        iconSize: [28,28],
        iconAnchor: [14,28]
    });
}

const categorySymbols = {
    "Pizzerie e Ristoranti": {symbol:"üçï", color:"#1e8f2e"},
    "Parcheggi": {symbol:"P", color:"#1976d2"},
    "Hotel": {symbol:"üõè", color:"#ff9800"}
};

const categoryMarkers = {};
const first4Markers = L.layerGroup();

Papa.parse(csvURL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        const data = results.data;
        const first4 = data.slice(0,4);

        // primi 4 marker
        first4.forEach(p => {
            const lat = parseFloat(p['Latitudine']);
            const lon = parseFloat(p['Longitudine']);
            if(isNaN(lat) || isNaN(lon)) return;

            let category = p['Categoria'] || 'Altro';
            if(category.toLowerCase() === 'pizzeria') category = 'Pizzerie e Ristoranti';

            let symbol = p['Simbolo'] || '‚ùì';
            let color = p['Colore'] || '#FF9800';

            let popupHTML = '';
            for(let key in p) if(p[key]) popupHTML += `<b>${key}</b>: ${p[key]}<br>`;
            popupHTML += `<a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Naviga qui</a>`;

            const marker = L.marker([lat, lon], {icon:createIcon(symbol,color)}).bindPopup(popupHTML);
            marker.addTo(map);
            first4Markers.addLayer(marker);
        });

        // altri marker
        data.slice(4).forEach(p => {
            const lat = parseFloat(p['Latitudine']);
            const lon = parseFloat(p['Longitudine']);
            if(isNaN(lat) || isNaN(lon)) return;

            let category = p['Categoria'] || 'Altro';
            if(category.toLowerCase() === 'pizzeria') category = 'Pizzerie e Ristoranti';

            let symbol = p['Simbolo'] || '‚ùì';
            let color = p['Colore'] || '#FF9800';
            if(category.toLowerCase().includes('parcheggio')) { symbol = p['Simbolo'] || '‚ùì'; color = p['Colore'] || '#2196F3'; }
            if(category.toLowerCase() === 'hotel') { symbol='üõè'; color='#ff9800'; }
            if(category.toLowerCase() === 'pizzerie e ristoranti') { symbol='üçï'; color='#1e8f2e'; }

            let popupHTML='';
            for(let key in p) if(p[key]) popupHTML += `<b>${key}</b>: ${p[key]}<br>`;
            popupHTML += `<a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Naviga qui</a>`;

            const marker = L.marker([lat, lon], {icon:createIcon(symbol,color)}).bindPopup(popupHTML);

            if(!categoryMarkers[category]) categoryMarkers[category] = L.layerGroup();
            categoryMarkers[category].addLayer(marker);
        });

        // overlay
        const overlays = {};
        overlays["Punti principali"] = first4Markers;
        Object.keys(categoryMarkers).forEach(cat => overlays[cat] = categoryMarkers[cat]);

        const layerControl = L.control.layers(null, overlays, {collapsed:false}).addTo(map);

        setTimeout(()=>{
            const container = layerControl.getContainer();
            const inputs = container.querySelectorAll('input[type=checkbox]');
            inputs.forEach(inp=>{
                inp.checked = true;
                if(inp.parentElement.textContent.trim() === "Punti principali") {
                    inp.disabled = true; // sempre disabilitata
                }
            });

            // aggiungi simboli/colori
            Object.keys(overlays).forEach(cat=>{
                const label = [...container.querySelectorAll('label')].find(l=>l.textContent.trim()===cat);
                if(label){
                    let sym = document.createElement('div');
                    let color='gray', symbol='?';
                    if(cat==='Punti principali'){ symbol='‚≠ê'; color='#d81b60'; }
                    else if(categorySymbols[cat]){ symbol=categorySymbols[cat].symbol; color=categorySymbols[cat].color; }
                    sym.style.backgroundColor=color;
                    sym.style.color='white';
                    sym.style.width='20px';
                    sym.style.height='20px';
                    sym.style.borderRadius='50%';
                    sym.style.display='flex';
                    sym.style.alignItems='center';
                    sym.style.justifyContent='center';
                    sym.style.fontSize='14px';
                    sym.style.marginRight='4px';
                    sym.textContent = symbol;
                    label.prepend(sym);
                }
            });
        },100);

        // logo sopra checkbox
        const logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Logo_example.png';
        const container = layerControl.getContainer();
        const logoImg = document.createElement('img');
        logoImg.src = logoUrl;
        container.prepend(logoImg);
    }
});
</script>
</body>
</html>
