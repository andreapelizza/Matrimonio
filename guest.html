<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mappa Hotel e Punti</title>
<link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: 'Kaushan Script', sans-serif; margin:0; }
#map { height:95vh; width:95%; max-width:1200px; margin:auto; border-radius:8px; }
.marker-special div { display:flex; align-items:center; justify-content:center; color:white; border-radius:50%; width:28px; height:28px; border:2px solid white; font-size:14px; font-family: 'Kaushan Script', sans-serif; }
a { color:#1976d2; text-decoration:none; font-family: 'Kaushan Script', sans-serif; }
a:hover { text-decoration:underline; font-family: 'Kaushan Script', sans-serif; }
.leaflet-control-layers-overlays label { font-family: 'Kaushan Script', sans-serif; display:flex; align-items:center; gap:4px; }
.leaflet-control-layers-overlays img { width:20px; height:20px; margin-bottom:4px; }
.legend { background:white; padding:8px; border-radius:6px; line-height:1.4; font-family: 'Kaushan Script', sans-serif; }
.legend .item { display:flex; align-items:center; margin-bottom:4px; }
.legend .symbol { width:20px; height:20px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:white; margin-right:6px; font-size:14px; border:1px solid #ccc; }
</style>
</head>
<body>
<div id="map"></div>

<script>
const CENTRO = { lat: 44.139605, lon: 12.140695 };
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb906YKDfS2Y2Ly7LynAAaYSegdjv0zOKP4paY_i0oBIK8nii4h9v3htSkT-1VigcLfvv08ar4iC6Z/pub?gid=1561792900&single=true&output=csv";

const map = L.map('map').setView([CENTRO.lat, CENTRO.lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

function createIcon(symbol, color="#FF9800") {
    return L.divIcon({
        className: 'marker-special',
        html: `<div style="background-color:${color}">${symbol}</div>`,
        iconSize: [28,28],
        iconAnchor: [14,28]
    });
}

// Simboli e colori per categorie fisse
const categorySymbols = {
    "Pizzerie e Ristoranti": {symbol:"üçï", color:"#1e8f2e"},
    "Parcheggi": {symbol:"P", color:"#1976d2"},
    "Hotel": {symbol:"üõè", color:"#ff9800"}
};

const categoryMarkers = {};
const alwaysVisibleMarkers = [];

Papa.parse(csvURL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        const first4 = results.data.slice(0,4);

        // Legenda primi 4 punti
        const legend = L.control({position:'topright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div','legend');
            div.innerHTML = "<b>Punti principali</b><br>";
            first4.forEach(p => {
                const color = p['Colore'] || "#FF9800";
                const symbol = p['Simbolo'] || "‚ùì";
                const label = p['Descrizione'] || "Punto";
                div.innerHTML += `<div class="item"><div class="symbol" style="background-color:${color}">${symbol}</div>${label}</div>`;
            });
            return div;
        };
        legend.addTo(map);

        results.data.forEach((p,index) => {
            const lat = parseFloat(p['Latitudine']);
            const lon = parseFloat(p['Longitudine']);
            if(isNaN(lat) || isNaN(lon)) return;

            let category = p['Categoria'] || 'Altro';
            if(category.toLowerCase() === 'pizzeria') category = 'Pizzerie e Ristoranti';

            let symbol = p['Simbolo'] || '‚ùì';
            let color = p['Colore'] || '#FF9800';
            if(category.toLowerCase().includes('parcheggio')) {
                symbol = 'P';
                color = '#1976d2';
            }
            if(category.toLowerCase() === "hotel") {
                symbol = "üõè";
                color = "#ff9800";
            }
            if(category.toLowerCase() === "pizzerie e ristoranti") {
                symbol = "üçï";
                color = "#1e8f2e";
            }

            let popupHTML = `<b>${p['Descrizione'] || 'Punto'}</b>`;
            if(p['Indirizzo']) popupHTML += `<br>${p['Indirizzo']}`;
            if(p['Telefono']) popupHTML += `<br>Tel: <a href="tel:${p['Telefono']}">${p['Telefono']}</a>`;
            if(category.toLowerCase().includes('parcheggio')) {
                popupHTML += `<br>Posti: ${p['Posti auto'] || ''}`;
                popupHTML += `<br>Accessibilit√†: ${p['Accessibilit√†'] || ''}`;
                popupHTML += `<br>Distanza: ${p['Distanza dal Comune'] || ''}`;
                popupHTML += `<br>Lunghezza percorso: ${p['Lunghezza percorso dal Comune'] || ''}`;
                popupHTML += `<br>Dislivello: ${p['Dislivello'] || ''}`;
            }
            popupHTML += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Naviga qui</a>`;

            const marker = L.marker([lat,lon], { icon: createIcon(symbol, color) }).bindPopup(popupHTML);

            if(index>=0 && index<=3){
                marker.addTo(map);
                alwaysVisibleMarkers.push(marker);
            } else {
                if(!categoryMarkers[category]) categoryMarkers[category] = L.layerGroup();
                categoryMarkers[category].addLayer(marker);
            }
        });

        // LayerGroup e controllo layer
        const overlays = {};
        Object.keys(categoryMarkers).forEach(cat => {
            categoryMarkers[cat].addTo(map);
            overlays[cat] = categoryMarkers[cat];
        });

        const layerControl = L.control.layers(null, overlays, {collapsed:false}).addTo(map);

        // Forza checkbox spuntate di default
        setTimeout(()=> {
            const container = layerControl.getContainer();
            const inputs = container.querySelectorAll('input[type=checkbox]');
            inputs.forEach(inp => inp.checked = true);

            // Aggiungi simbolo e colore accanto a ogni checkbox
            Object.keys(categoryMarkers).forEach(cat => {
                const label = [...container.querySelectorAll('label')].find(l => l.textContent.trim() === cat);
                if(label && categorySymbols[cat]) {
                    const sym = document.createElement('div');
                    sym.style.backgroundColor = categorySymbols[cat].color;
                    sym.style.color = "white";
                    sym.style.width = "20px";
                    sym.style.height = "20px";
                    sym.style.borderRadius = "50%";
                    sym.style.display = "flex";
                    sym.style.alignItems = "center";
                    sym.style.justifyContent = "center";
                    sym.style.fontSize = "14px";
                    sym.style.marginRight = "4px";
                    sym.textContent = categorySymbols[cat].symbol;
                    label.prepend(sym);
                }
            });
        },100);

        // Aggiungi logo sopra i checkbox
        const logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Logo_example.png';
        const container = layerControl.getContainer();
        const logoImg = document.createElement('img');
        logoImg.src = logoUrl;
        container.prepend(logoImg);
    }
});
</script>
</body>
</html>
